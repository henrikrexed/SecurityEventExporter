name: Release

on:
  push:
    tags:
      - 'v*'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
      security-events: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Generate SBOM for Go module
        uses: anchore/sbom-action@v0
        with:
          path: .
          format: spdx-json
          output-file: sbom-go.spdx.json

      - name: Generate SBOM for Docker image
        uses: anchore/sbom-action@v0
        with:
          image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.ref_name }}
          format: spdx-json
          output-file: sbom-docker.spdx.json

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          body: |
            ## OpenTelemetry Security Event Exporter ${{ github.ref_name }}
            
            ### What's New
            - Security Event Exporter for OpenTelemetry Collector
            - Docker image with pre-built collector
            - Comprehensive documentation and examples
            
            ### Downloads
            - Docker image: `${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.ref_name }}`
            - SBOM files are attached to this release
            
            ### Documentation
            - [Live Documentation](https://henrikrexed.github.io/SecurityEventExporter/)
            - [API Reference](docs/API.md)
            - [Deployment Guide](docs/DEPLOYMENT.md)
          files: |
            sbom-go.spdx.json
            sbom-docker.spdx.json
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
